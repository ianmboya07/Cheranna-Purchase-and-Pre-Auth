<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cheranna SoftPOS - Complete Payment Solution</title>
    <meta name="description" content="Secure payment processing with pre-authorization and capture">
    <script src="https://js.stripe.com/v3/"></script>
    <style>
        :root {
            --primary: #4a6cf7;
            --primary-dark: #3b5be3;
            --secondary: #6c757d;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --light: #f8f9fa;
            --dark: #343a40;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7ff;
            color: #333;
            line-height: 1.6;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 30px;
            position: relative;
        }
        
        h1 {
            text-align: center;
            color: var(--primary);
            margin-bottom: 30px;
            font-size: 2rem;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 30px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .tab {
            padding: 12px 24px;
            cursor: pointer;
            font-weight: 600;
            border-bottom: 3px solid transparent;
            transition: var(--transition);
        }
        
        .tab.active {
            color: var(--primary);
            border-bottom: 3px solid var(--primary);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        .section {
            margin-bottom: 30px;
            padding: 25px;
            border-radius: var(--border-radius);
            background: var(--light);
            border: 1px solid #e9ecef;
        }
        
        h2 {
            color: var(--primary);
            margin-bottom: 20px;
            font-size: 1.5rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        h2 i {
            font-size: 1.2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
        }
        
        .required::after {
            content: " *";
            color: var(--danger);
        }
        
        input, select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 16px;
            transition: var(--transition);
            background: white;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 108, 247, 0.1);
        }
        
        input.error, select.error {
            border-color: var(--danger);
            box-shadow: 0 0 0 3px rgba(220, 53, 69, 0.1);
        }
        
        .currency-input {
            display: flex;
            align-items: center;
        }
        
        .currency-symbol {
            background: #e9ecef;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-right: none;
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            font-weight: 600;
            color: var(--dark);
        }
        
        .currency-input input {
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
        }
        
        .error {
            color: var(--danger);
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .error.show {
            display: block;
        }
        
        .order-summary {
            background: #e8f4ff;
            padding: 20px;
            border-radius: var(--border-radius);
            margin-bottom: 20px;
            border: 1px solid #cfe2ff;
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 5px 0;
        }
        
        .total {
            font-weight: 700;
            font-size: 1.2rem;
            border-top: 2px solid #b6d4fe;
            padding-top: 15px;
            margin-top: 10px;
            color: var(--primary);
        }
        
        .transaction-type-selector {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .transaction-type-btn {
            flex: 1;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            background: white;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            transition: var(--transition);
            font-size: 16px;
        }
        
        .transaction-type-btn:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
        }
        
        .transaction-type-btn.active {
            border-color: var(--primary);
            background: var(--primary);
            color: white;
            box-shadow: 0 4px 8px rgba(74, 108, 247, 0.3);
        }
        
        .transaction-type-btn.warning.active {
            border-color: var(--warning);
            background: var(--warning);
            color: var(--dark);
            box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
        }
        
        .transaction-info {
            background: #fff9e6;
            border-left: 4px solid var(--warning);
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .transaction-info.show {
            display: block;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 16px 20px;
            border-radius: var(--border-radius);
            font-size: 17px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            position: relative;
            overflow: hidden;
        }
        
        button:hover:not(:disabled) {
            background: var(--primary-dark);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }
        
        button:active:not(:disabled) {
            transform: translateY(0);
        }
        
        button:disabled {
            background: var(--secondary);
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        button.warning {
            background: var(--warning);
            color: var(--dark);
        }
        
        button.warning:hover:not(:disabled) {
            background: #e0a800;
        }
        
        button.success {
            background: var(--success);
            color: white;
        }
        
        button.success:hover:not(:disabled) {
            background: #218838;
        }
        
        #payment-message, #capture-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: var(--border-radius);
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .warning-message {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        button.warning .loading-spinner {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-top: 3px solid var(--dark);
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .security-badge {
            text-align: center;
            margin-top: 20px;
            padding: 10px;
            color: var(--secondary);
            font-size: 14px;
            border-top: 1px solid #e9ecef;
        }
        
        .security-badge i {
            color: var(--success);
            margin-right: 5px;
        }
        
        .pending-transactions {
            margin-top: 30px;
        }
        
        .transaction-list {
            max-height: 300px;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: var(--border-radius);
        }
        
        .transaction-item {
            padding: 15px;
            border-bottom: 1px solid #e9ecef;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .transaction-item:last-child {
            border-bottom: none;
        }
        
        .transaction-details {
            flex: 1;
        }
        
        .transaction-amount {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary);
        }
        
        .transaction-id {
            font-size: 0.85rem;
            color: var(--secondary);
            margin-top: 5px;
        }
        
        .transaction-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-small {
            padding: 8px 12px;
            font-size: 14px;
            width: auto;
        }
        
        .empty-state {
            text-align: center;
            padding: 30px;
            color: var(--secondary);
        }
        
        /* Billing Address Section - Ensure all fields are visible */
        .billing-section {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .billing-section .form-group {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        .billing-section input,
        .billing-section select {
            display: block !important;
            opacity: 1 !important;
            visibility: visible !important;
        }
        
        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }
            
            .section {
                padding: 20px;
            }
            
            .transaction-type-selector {
                flex-direction: column;
                gap: 10px;
            }
            
            h1 {
                font-size: 1.75rem;
            }
            
            h2 {
                font-size: 1.3rem;
            }
            
            .transaction-item {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .transaction-actions {
                margin-top: 10px;
                width: 100%;
            }
            
            .btn-small {
                flex: 1;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .container {
                padding: 15px;
            }
            
            .section {
                padding: 15px;
            }
            
            .tabs {
                flex-direction: column;
            }
            
            .tab {
                border-bottom: 1px solid #e9ecef;
                border-left: 3px solid transparent;
            }
            
            .tab.active {
                border-left: 3px solid var(--primary);
                border-bottom: 1px solid #e9ecef;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Cheranna SoftPOS</h1>
        
        <!-- Tabs for different functions -->
        <div class="tabs">
            <div class="tab active" data-tab="payment">Process Payment</div>
            <div class="tab" data-tab="capture">Complete Authorization</div>
            <div class="tab" data-tab="transactions">Pending Transactions</div>
        </div>
        
        <!-- Payment Tab -->
        <div class="tab-content active" id="payment-tab">
            <!-- Order Summary Section -->
            <div class="section">
                <h2>Order Summary</h2>
                
                <!-- Transaction Type Selector -->
                <div class="transaction-type-selector">
                    <div class="transaction-type-btn active" data-type="payment" id="payment-btn">
                        Payment
                    </div>
                    <div class="transaction-type-btn warning" data-type="pre-auth" id="pre-auth-btn">
                        Pre-Authorization
                    </div>
                </div>
                
                <div class="transaction-info" id="pre-auth-info">
                    <strong>Pre-Authorization Notice:</strong> This will reserve funds on the customer's card but will not charge them immediately. You'll need to capture the funds later to complete the transaction.
                </div>
                
                <div class="form-group">
                    <label for="amount" class="required">Payment Amount (USD)</label>
                    <div class="currency-input">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="amount" placeholder="0" inputmode="numeric" min="1" step="1" required>
                    </div>
                    <div id="amount-error" class="error">Please enter a valid whole dollar amount (minimum $1)</div>
                </div>
                
                <div class="order-summary">
                    <div class="summary-item">
                        <span>Amount:</span>
                        <span id="display-amount">$0</span>
                    </div>
                    <div class="summary-item">
                        <span>Transaction Type:</span>
                        <span id="display-type">Payment</span>
                    </div>
                    <div class="summary-item total">
                        <span>Total:</span>
                        <span id="display-total">$0</span>
                    </div>
                </div>
            </div>
            
            <!-- Billing Information -->
            <div class="section billing-section">
                <h2>Billing Information</h2>
                <div class="form-group">
                    <label for="name" class="required">Full Name</label>
                    <input type="text" id="name" placeholder="John Doe" required maxlength="100">
                    <div id="name-error" class="error">Please enter your full name (max 100 characters)</div>
                </div>
                
                <div class="form-group">
                    <label for="email" class="required">Email Address</label>
                    <input type="email" id="email" placeholder="john.doe@example.com" required maxlength="100">
                    <div id="email-error" class="error">Please enter a valid email address</div>
                </div>
                
                <div class="form-group">
                    <label for="line1" class="required">Address Line 1</label>
                    <input type="text" id="line1" placeholder="123 Main St" required maxlength="200">
                    <div id="line1-error" class="error">Please enter your address (max 200 characters)</div>
                </div>
                
                <div class="form-group">
                    <label for="line2">Address Line 2 (Optional)</label>
                    <input type="text" id="line2" placeholder="Apt 456" maxlength="100">
                </div>
                
                <div class="form-group">
                    <label for="city" class="required">City</label>
                    <input type="text" id="city" placeholder="New York" required maxlength="50">
                    <div id="city-error" class="error">Please enter your city (max 50 characters)</div>
                </div>
                
                <div class="form-group">
                    <label for="state" class="required">State/Province/Region</label>
                    <input type="text" id="state" placeholder="NY" required maxlength="50">
                    <div id="state-error" class="error">Please enter your state/region (max 50 characters)</div>
                </div>
                
                <div class="form-group">
                    <label for="postal_code" class="required">Postal Code</label>
                    <input type="text" id="postal_code" placeholder="10001" required maxlength="20">
                    <div id="postal-code-error" class="error">Please enter your postal code</div>
                </div>
                
                <div class="form-group">
                    <label for="country" class="required">Country</label>
                    <select id="country" required></select>
                    <div id="country-error" class="error">Please select your country</div>
                </div>
            </div>
            
            <!-- Payment Section -->
            <div class="section">
                <h2>Payment Details</h2>
                <div class="form-group">
                    <label for="card-element" class="required">Credit or Debit Card</label>
                    <div id="card-element"></div>
                    <div id="card-errors" class="error"></div>
                </div>
                
                <button id="submit-button" disabled>
                    <div id="spinner" class="loading-spinner"></div>
                    <span id="button-text">Pay $0</span>
                </button>
                
                <div id="payment-message"></div>
            </div>
        </div>
        
        <!-- Capture Tab -->
        <div class="tab-content" id="capture-tab">
            <div class="section">
                <h2>Complete Authorization</h2>
                <div class="form-group">
                    <label for="payment-intent-id" class="required">Payment Intent ID</label>
                    <input type="text" id="payment-intent-id" placeholder="pi_xxxxxxxxxxxxx" required pattern="pi_[a-zA-Z0-9_]+">
                    <div id="payment-intent-id-error" class="error">Please enter a valid Payment Intent ID starting with "pi_"</div>
                </div>
                
                <div class="form-group">
                    <label for="capture-amount" class="required">Capture Amount (USD)</label>
                    <div class="currency-input">
                        <span class="currency-symbol">$</span>
                        <input type="number" id="capture-amount" placeholder="0" inputmode="numeric" min="1" step="1" required>
                    </div>
                    <div id="capture-amount-error" class="error">Please enter a valid amount to capture (minimum $1)</div>
                </div>
                
                <button id="capture-button" class="success">
                    <div id="capture-spinner" class="loading-spinner"></div>
                    <span id="capture-button-text">Capture Funds</span>
                </button>
                
                <div id="capture-message"></div>
            </div>
            
            <div class="section pending-transactions">
                <h2>Recent Pre-Authorizations</h2>
                <div class="transaction-list" id="transaction-list">
                    <div class="empty-state">No recent pre-authorizations found</div>
                </div>
            </div>
        </div>
        
        <!-- Transactions Tab -->
        <div class="tab-content" id="transactions-tab">
            <div class="section">
                <h2>Transaction Management</h2>
                <div class="form-group">
                    <button id="refresh-transactions" class="success">
                        Refresh Transactions
                    </button>
                </div>
                
                <div class="transaction-list" id="all-transactions-list">
                    <div class="empty-state">No transactions found</div>
                </div>
            </div>
        </div>
        
        <div class="security-badge">
            <i>🔒</i> Secure SSL Encryption • PCI DSS Compliant
        </div>
    </div>

    <script>
        // Configuration - Use environment variables in production
        const STRIPE_PUBLISHABLE_KEY = 'pk_live_51R2yuLFKJ2Qtcy9Lf5eA50tPeQdQYMuDhi5E9ur0qWggBg4lqD0ikQgbWEyHsTg9LNtlLx4yKpzEBDY9pZCRR3wx00eCaGkuVa';
        const API_BASE_URL = '/api'; // Adjust based on your server configuration
        
        // Rate limiting configuration
        const RATE_LIMIT = {
            attempts: 3,
            window: 60000, // 1 minute
            lockout: 300000 // 5 minutes
        };
        
        let rateLimitAttempts = 0;
        let rateLimitResetTime = 0;
        let lastAttemptTime = 0;
        
        // Initialize Stripe
        const stripe = Stripe(STRIPE_PUBLISHABLE_KEY);
        const elements = stripe.elements();
        
        // Set up Stripe Elements with custom styling
        const cardElement = elements.create('card', {
            style: {
                base: {
                    fontSize: '16px',
                    color: '#32325d',
                    fontFamily: '"Segoe UI", Tahoma, Geneva, Verdana, sans-serif',
                    '::placeholder': {
                        color: '#aab7c4'
                    }
                },
                invalid: {
                    color: '#dc3545'
                }
            },
            hidePostalCode: true
        });
        
        cardElement.mount('#card-element');
        
        // Handle real-time validation errors from the card Element
        cardElement.on('change', function(event) {
            const displayError = document.getElementById('card-errors');
            if (event.error) {
                displayError.textContent = event.error.message;
                displayError.classList.add('show');
                validateForm();
            } else {
                displayError.textContent = '';
                displayError.classList.remove('show');
                validateForm();
            }
        });
        
        // Tab navigation
        const tabs = document.querySelectorAll('.tab');
        const tabContents = document.querySelectorAll('.tab-content');
        
        tabs.forEach(tab => {
            tab.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // Update active tab
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Update active content
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
                
                // Load transactions if on capture or transactions tab
                if (tabId === 'capture' || tabId === 'transactions') {
                    loadPendingTransactions();
                }
            });
        });
        
        // Transaction type handling
        let transactionType = 'payment';
        const transactionTypeButtons = document.querySelectorAll('.transaction-type-btn');
        const preAuthInfo = document.getElementById('pre-auth-info');
        const displayType = document.getElementById('display-type');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        
        transactionTypeButtons.forEach(button => {
            button.addEventListener('click', function() {
                // Remove active class from all buttons
                transactionTypeButtons.forEach(btn => {
                    btn.classList.remove('active');
                });
                
                // Add active class to clicked button
                this.classList.add('active');
                
                // Update transaction type
                transactionType = this.getAttribute('data-type');
                
                // Update UI based on transaction type
                updateTransactionUI();
                validateForm();
            });
        });
        
        function updateTransactionUI() {
            const amount = parseInt(amountInput.value, 10) || 0;
            
            if (transactionType === 'pre-auth') {
                preAuthInfo.classList.add('show');
                displayType.textContent = 'Pre-Authorization';
                submitButton.classList.add('warning');
            } else {
                preAuthInfo.classList.remove('show');
                displayType.textContent = 'Payment';
                submitButton.classList.remove('warning');
            }
            
            updateButtonText();
        }
        
        // Country dropdown population - Complete list of UN member states with ISO 3166-1 alpha-2 codes
        const countrySelect = document.getElementById('country');
        const unMemberStates = [
            {code: "AF", name: "Afghanistan"}, {code: "AL", name: "Albania"}, {code: "DZ", name: "Algeria"},
            {code: "AD", name: "Andorra"}, {code: "AO", name: "Angola"}, {code: "AG", name: "Antigua and Barbuda"},
            {code: "AR", name: "Argentina"}, {code: "AM", name: "Armenia"}, {code: "AU", name: "Australia"},
            {code: "AT", name: "Austria"}, {code: "AZ", name: "Azerbaijan"}, {code: "BS", name: "Bahamas"},
            {code: "BH", name: "Bahrain"}, {code: "BD", name: "Bangladesh"}, {code: "BB", name: "Barbados"},
            {code: "BY", name: "Belarus"}, {code: "BE", name: "Belgium"}, {code: "BZ", name: "Belize"},
            {code: "BJ", name: "Benin"}, {code: "BT", name: "Bhutan"}, {code: "BO", name: "Bolivia (Plurinational State)"},
            {code: "BA", name: "Bosnia and Herzegovina"}, {code: "BW", name: "Botswana"}, {code: "BR", name: "Brazil"},
            {code: "BN", name: "Brunei Darussalam"}, {code: "BG", name: "Bulgaria"}, {code: "BF", name: "Burkina Faso"},
            {code: "BI", name: "Burundi"}, {code: "CV", name: "Cabo Verde"}, {code: "KH", name: "Cambodia"},
            {code: "CM", name: "Cameroon"}, {code: "CA", name: "Canada"}, {code: "CF", name: "Central African Republic"},
            {code: "TD", name: "Chad"}, {code: "CL", name: "Chile"}, {code: "CN", name: "China"},
            {code: "CO", name: "Colombia"}, {code: "KM", name: "Comoros"}, {code: "CG", name: "Congo"},
            {code: "CD", name: "Congo (Democratic Republic)"}, {code: "CR", name: "Costa Rica"},
            {code: "CI", name: "Côte d'Ivoire"}, {code: "HR", name: "Croatia"}, {code: "CU", name: "Cuba"},
            {code: "CY", name: "Cyprus"}, {code: "CZ", name: "Czech Republic"}, {code: "DK", name: "Denmark"},
            {code: "DJ", name: "Djibouti"}, {code: "DM", name: "Dominica"}, {code: "DO", name: "Dominican Republic"},
            {code: "EC", name: "Ecuador"}, {code: "EG", name: "Egypt"}, {code: "SV", name: "El Salvador"},
            {code: "GQ", name: "Equatorial Guinea"}, {code: "ER", name: "Eritrea"}, {code: "EE", name: "Estonia"},
            {code: "SZ", name: "Eswatini"}, {code: "ET", name: "Ethiopia"}, {code: "FJ", name: "Fiji"},
            {code: "FI", name: "Finland"}, {code: "FR", name: "France"}, {code: "GA", name: "Gabon"},
            {code: "GM", name: "Gambia"}, {code: "GE", name: "Georgia"}, {code: "DE", name: "Germany"},
            {code: "GH", name: "Ghana"}, {code: "GR", name: "Greece"}, {code: "GD", name: "Grenada"},
            {code: "GT", name: "Guatemala"}, {code: "GN", name: "Guinea"}, {code: "GW", name: "Guinea-Bissau"},
            {code: "GY", name: "Guyana"}, {code: "HT", name: "Haiti"}, {code: "HN", name: "Honduras"},
            {code: "HU", name: "Hungary"}, {code: "IS", name: "Iceland"}, {code: "IN", name: "India"},
            {code: "ID", name: "Indonesia"}, {code: "IR", name: "Iran (Islamic Republic)"}, {code: "IQ", name: "Iraq"},
            {code: "IE", name: "Ireland"}, {code: "IL", name: "Israel"}, {code: "IT", name: "Italy"},
            {code: "JM", name: "Jamaica"}, {code: "JP", name: "Japan"}, {code: "JO", name: "Jordan"},
            {code: "KZ", name: "Kazakhstan"}, {code: "KE", name: "Kenya"}, {code: "KI", name: "Kiribati"},
            {code: "KP", name: "Korea (Democratic People's Republic)"}, {code: "KR", name: "Korea (Republic)"}, {code: "KW", name: "Kuwait"},
            {code: "KG", name: "Kyrgyzstan"}, {code: "LA", name: "Lao People's Democratic Republic"}, {code: "LV", name: "Latvia"},
            {code: "LB", name: "Lebanon"}, {code: "LS", name: "Lesotho"}, {code: "LR", name: "Liberia"},
            {code: "LY", name: "Libya"}, {code: "LI", name: "Liechtenstein"}, {code: "LT", name: "Lithuania"},
            {code: "LU", name: "Luxembourg"}, {code: "MG", name: "Madagascar"}, {code: "MW", name: "Malawi"},
            {code: "MY", name: "Malaysia"}, {code: "MV", name: "Maldives"}, {code: "ML", name: "Mali"},
            {code: "MT", name: "Malta"}, {code: "MH", name: "Marshall Islands"}, {code: "MR", name: "Mauritania"},
            {code: "MU", name: "Mauritius"}, {code: "MX", name: "Mexico"}, {code: "FM", name: "Micronesia (Federated States)"},
            {code: "MD", name: "Moldova (Republic)"}, {code: "MC", name: "Monaco"}, {code: "MN", name: "Mongolia"},
            {code: "ME", name: "Montenegro"}, {code: "MA", name: "Morocco"}, {code: "MZ", name: "Mozambique"},
            {code: "MM", name: "Myanmar"}, {code: "NA", name: "Namibia"}, {code: "NR", name: "Nauru"},
            {code: "NP", name: "Nepal"}, {code: "NL", name: "Netherlands"}, {code: "NZ", name: "New Zealand"},
            {code: "NI", name: "Nicaragua"}, {code: "NE", name: "Niger"}, {code: "NG", name: "Nigeria"},
            {code: "MK", name: "North Macedonia"}, {code: "NO", name: "Norway"}, {code: "OM", name: "Oman"},
            {code: "PK", name: "Pakistan"}, {code: "PW", name: "Palau"}, {code: "PA", name: "Panama"},
            {code: "PG", name: "Papua New Guinea"}, {code: "PY", name: "Paraguay"}, {code: "PE", name: "Peru"},
            {code: "PH", name: "Philippines"}, {code: "PL", name: "Poland"}, {code: "PT", name: "Portugal"},
            {code: "QA", name: "Qatar"}, {code: "RO", name: "Romania"}, {code: "RU", name: "Russian Federation"},
            {code: "RW", name: "Rwanda"}, {code: "KN", name: "Saint Kitts and Nevis"}, {code: "LC", name: "Saint Lucia"},
            {code: "VC", name: "Saint Vincent and the Grenadines"}, {code: "WS", name: "Samoa"}, {code: "SM", name: "San Marino"},
            {code: "ST", name: "Sao Tome and Principe"}, {code: "SA", name: "Saudi Arabia"}, {code: "SN", name: "Senegal"},
            {code: "RS", name: "Serbia"}, {code: "SC", name: "Seychelles"}, {code: "SL", name: "Sierra Leone"},
            {code: "SG", name: "Singapore"}, {code: "SK", name: "Slovakia"}, {code: "SI", name: "Slovenia"},
            {code: "SB", name: "Solomon Islands"}, {code: "SO", name: "Somalia"}, {code: "ZA", name: "South Africa"},
            {code: "SS", name: "South Sudan"}, {code: "ES", name: "Spain"}, {code: "LK", name: "Sri Lanka"},
            {code: "SD", name: "Sudan"}, {code: "SR", name: "Suriname"}, {code: "SE", name: "Sweden"},
            {code: "CH", name: "Switzerland"}, {code: "SY", name: "Syrian Arab Republic"}, {code: "TJ", name: "Tajikistan"},
            {code: "TZ", name: "Tanzania (United Republic)"}, {code: "TH", name: "Thailand"}, {code: "TL", name: "Timor-Leste"},
            {code: "TG", name: "Togo"}, {code: "TO", name: "Tonga"}, {code: "TT", name: "Trinidad and Tobago"},
            {code: "TN", name: "Tunisia"}, {code: "TR", name: "Turkey"}, {code: "TM", name: "Turkmenistan"},
            {code: "TV", name: "Tuvalu"}, {code: "UG", name: "Uganda"}, {code: "UA", name: "Ukraine"},
            {code: "AE", name: "United Arab Emirates"}, {code: "GB", name: "United Kingdom of Great Britain and Northern Ireland"},
            {code: "US", name: "United States of America"}, {code: "UY", name: "Uruguay"}, {code: "UZ", name: "Uzbekistan"},
            {code: "VU", name: "Vanuatu"}, {code: "VE", name: "Venezuela (Bolivarian Republic)"}, {code: "VN", name: "Viet Nam"},
            {code: "YE", name: "Yemen"}, {code: "ZM", name: "Zambia"}, {code: "ZW", name: "Zimbabwe"}
        ];
        
        // Sort by country name and populate dropdown
        unMemberStates.sort((a, b) => a.name.localeCompare(b.name)).forEach(country => {
            const option = document.createElement('option');
            option.value = country.code;
            option.textContent = country.name;
            countrySelect.appendChild(option);
        });
        
        // Set default country to United States
        countrySelect.value = 'US';
        
        // Amount input handling
        const amountInput = document.getElementById('amount');
        const displayAmount = document.getElementById('display-amount');
        const displayTotal = document.getElementById('display-total');
        
        amountInput.addEventListener('input', function() {
            const amount = parseInt(this.value, 10) || 0;
            
            // Update display
            displayAmount.textContent = `$${amount.toLocaleString()}`;
            displayTotal.textContent = `$${amount.toLocaleString()}`;
            
            // Update button text
            updateButtonText();
            
            // Validate form
            validateForm();
        });
        
        function updateButtonText() {
            const amount = parseInt(amountInput.value, 10) || 0;
            const action = transactionType === 'pre-auth' ? 'Authorize' : 'Pay';
            buttonText.textContent = `${action} $${amount.toLocaleString()}`;
        }
        
        // Form validation
        const requiredFields = [
            'name', 'email', 'line1', 'city', 'state', 'postal_code', 'country'
        ];
        
        function validateForm() {
            let isValid = true;
            
            // Check amount
            const amount = parseInt(amountInput.value, 10);
            if (!amount || amount < 1) {
                document.getElementById('amount-error').classList.add('show');
                isValid = false;
            } else {
                document.getElementById('amount-error').classList.remove('show');
            }
            
            // Check required fields
            requiredFields.forEach(field => {
                const element = document.getElementById(field);
                const errorElement = document.getElementById(`${field}-error`);
                
                if (!element.value.trim()) {
                    element.classList.add('error');
                    errorElement.classList.add('show');
                    isValid = false;
                } else {
                    element.classList.remove('error');
                    errorElement.classList.remove('show');
                }
            });
            
            // Check email format
            const email = document.getElementById('email');
            const emailError = document.getElementById('email-error');
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (email.value && !emailRegex.test(email.value)) {
                email.classList.add('error');
                emailError.textContent = 'Please enter a valid email address';
                emailError.classList.add('show');
                isValid = false;
            }
            
            // Validate postal code based on country
            const postalCode = document.getElementById('postal_code').value;
            const country = document.getElementById('country').value;
            if (postalCode && !validatePostalCode(postalCode, country)) {
                document.getElementById('postal_code').classList.add('error');
                document.getElementById('postal-code-error').textContent = getPostalCodeValidationMessage(country);
                document.getElementById('postal-code-error').classList.add('show');
                isValid = false;
            }
            
            // Check card element
            const cardErrors = document.getElementById('card-errors');
            if (cardErrors.textContent) {
                isValid = false;
            }
            
            // Enable/disable submit button
            submitButton.disabled = !isValid;
            
            return isValid;
        }
        
        // Postal code validation
        function validatePostalCode(postalCode, country) {
            const cleanedPostalCode = postalCode.replace(/\s+/g, '');
            
            switch (country) {
                case 'US':
                    return /^\d{5}(-\d{4})?$/.test(cleanedPostalCode);
                case 'CA':
                    return /^[A-Za-z]\d[A-Za-z][ -]?\d[A-Za-z]\d$/.test(cleanedPostalCode);
                case 'GB':
                    return /^[A-Z]{1,2}\d[A-Z\d]? ?\d[A-Z]{2}$/i.test(cleanedPostalCode);
                case 'AU':
                    return /^\d{4}$/.test(cleanedPostalCode);
                default:
                    return cleanedPostalCode.length >= 3;
            }
        }
        
        function getPostalCodeValidationMessage(country) {
            switch (country) {
                case 'US': return 'Please enter a valid US ZIP code (e.g., 12345 or 12345-6789)';
                case 'CA': return 'Please enter a valid Canadian postal code (e.g., A1A 1A1)';
                case 'GB': return 'Please enter a valid UK postcode (e.g., SW1A 1AA)';
                case 'AU': return 'Please enter a valid Australian postcode (4 digits)';
                default: return 'Please enter a valid postal code';
            }
        }
        
        // Add validation on field change
        requiredFields.forEach(field => {
            const element = document.getElementById(field);
            element.addEventListener('blur', validateForm);
            element.addEventListener('input', function() {
                if (this.value.trim()) {
                    this.classList.remove('error');
                    document.getElementById(`${field}-error`).classList.remove('show');
                }
                validateForm();
            });
        });
        
        // Country change handler for postal code validation
        document.getElementById('country').addEventListener('change', function() {
            validateForm();
        });
        
        // Postal code specific validation
        document.getElementById('postal_code').addEventListener('blur', function() {
            validateForm();
        });
        
        // Email validation
        const emailField = document.getElementById('email');
        emailField.addEventListener('blur', function() {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (this.value && !emailRegex.test(this.value)) {
                this.classList.add('error');
                document.getElementById('email-error').textContent = 'Please enter a valid email address';
                document.getElementById('email-error').classList.add('show');
            }
            validateForm();
        });
        
        // Payment form submission
        const paymentForm = document.getElementById('payment-tab');
        const paymentMessage = document.getElementById('payment-message');
        const spinner = document.getElementById('spinner');
        
        // Prevent form submission on enter key in inputs
        const formInputs = paymentForm.querySelectorAll('input, select');
        formInputs.forEach(input => {
            input.addEventListener('keydown', function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault();
                }
            });
        });
        
        submitButton.addEventListener('click', async function(event) {
            event.preventDefault();
            
            if (!validateForm()) {
                showMessage(paymentMessage, 'Please fix the errors in the form before submitting.', 'error');
                return;
            }
            
            // Check rate limiting
            if (isRateLimited()) {
                showMessage(paymentMessage, 'Too many attempts. Please try again later.', 'error');
                return;
            }
            
            // Disable submit button and show loading state
            submitButton.disabled = true;
            spinner.style.display = 'block';
            buttonText.textContent = 'Processing...';
            
            try {
                // Collect billing details
                const billingDetails = {
                    name: document.getElementById('name').value.trim(),
                    email: document.getElementById('email').value.trim(),
                    address: {
                        line1: document.getElementById('line1').value.trim(),
                        line2: document.getElementById('line2').value.trim(),
                        city: document.getElementById('city').value.trim(),
                        state: document.getElementById('state').value.trim(),
                        postal_code: document.getElementById('postal_code').value.trim(),
                        country: document.getElementById('country').value,
                    }
                };
                
                // Create payment intent
                const { clientSecret, paymentIntentId } = await createPaymentIntent(
                    parseInt(amountInput.value, 10),
                    transactionType,
                    billingDetails
                );
                
                // Confirm payment with Stripe
                const { error, paymentIntent } = await stripe.confirmCardPayment(clientSecret, {
                    payment_method: {
                        card: cardElement,
                        billing_details: billingDetails
                    }
                });
                
                if (error) {
                    // Handle payment error
                    handlePaymentError(error);
                } else {
                    // Handle successful payment
                    handlePaymentSuccess(paymentIntent);
                }
            } catch (error) {
                console.error('Payment error:', error);
                handlePaymentError({ message: 'An unexpected error occurred. Please try again.' });
            } finally {
                // Reset button state
                submitButton.disabled = false;
                spinner.style.display = 'none';
                updateButtonText();
            }
        });
        
        // Create payment intent
        async function createPaymentIntent(amount, type, billingDetails) {
            try {
                const response = await fetch(`${API_BASE_URL}/create-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        amount: amount * 100, // Convert to cents
                        currency: 'usd',
                        capture_method: type === 'pre-auth' ? 'manual' : 'automatic',
                        metadata: {
                            billing_name: billingDetails.name,
                            billing_email: billingDetails.email,
                            billing_country: billingDetails.address.country
                        }
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to create payment intent');
                }
                
                const data = await response.json();
                return {
                    clientSecret: data.clientSecret,
                    paymentIntentId: data.paymentIntentId
                };
            } catch (error) {
                console.error('Error creating payment intent:', error);
                throw error;
            }
        }
        
        // Handle payment error
        function handlePaymentError(error) {
            showMessage(paymentMessage, error.message, 'error');
            recordFailedAttempt();
        }
        
        // Handle payment success
        function handlePaymentSuccess(paymentIntent) {
            const isPreAuth = paymentIntent.capture_method === 'manual';
            const message = isPreAuth 
                ? `Pre-authorization successful! Payment Intent ID: ${paymentIntent.id}. You can capture the funds later.`
                : `Payment successful! Transaction ID: ${paymentIntent.id}`;
            
            showMessage(paymentMessage, message, 'success');
            
            // Reset form
            resetPaymentForm();
            
            // Reset rate limiting on success
            resetRateLimit();
            
            // Load transactions if this was a pre-auth
            if (isPreAuth) {
                loadPendingTransactions();
            }
        }
        
        // Reset payment form
        function resetPaymentForm() {
            document.getElementById('amount').value = '';
            document.getElementById('name').value = '';
            document.getElementById('email').value = '';
            document.getElementById('line1').value = '';
            document.getElementById('line2').value = '';
            document.getElementById('city').value = '';
            document.getElementById('state').value = '';
            document.getElementById('postal_code').value = '';
            document.getElementById('country').value = 'US';
            
            cardElement.clear();
            
            displayAmount.textContent = '$0';
            displayTotal.textContent = '$0';
            updateButtonText();
            
            validateForm();
        }
        
        // Capture payment
        const captureButton = document.getElementById('capture-button');
        const captureSpinner = document.getElementById('capture-spinner');
        const captureMessage = document.getElementById('capture-message');
        
        captureButton.addEventListener('click', async function() {
            const paymentIntentId = document.getElementById('payment-intent-id').value.trim();
            const captureAmount = parseInt(document.getElementById('capture-amount').value, 10);
            
            if (!paymentIntentId) {
                showMessage(captureMessage, 'Please enter a Payment Intent ID', 'error');
                return;
            }
            
            if (!paymentIntentId.startsWith('pi_')) {
                showMessage(captureMessage, 'Please enter a valid Payment Intent ID starting with "pi_"', 'error');
                return;
            }
            
            if (!captureAmount || captureAmount < 1) {
                showMessage(captureMessage, 'Please enter a valid capture amount (minimum $1)', 'error');
                return;
            }
            
            // Disable button and show loading
            captureButton.disabled = true;
            captureSpinner.style.display = 'block';
            document.getElementById('capture-button-text').textContent = 'Processing...';
            
            try {
                const response = await fetch(`${API_BASE_URL}/capture-payment-intent`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        paymentIntentId: paymentIntentId,
                        amount: captureAmount * 100 // Convert to cents
                    }),
                });
                
                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error || 'Failed to capture payment');
                }
                
                const data = await response.json();
                showMessage(captureMessage, `Payment captured successfully! Amount: $${captureAmount.toLocaleString()}`, 'success');
                
                // Clear form
                document.getElementById('payment-intent-id').value = '';
                document.getElementById('capture-amount').value = '';
                
                // Refresh transaction list
                loadPendingTransactions();
            } catch (error) {
                console.error('Capture error:', error);
                showMessage(captureMessage, error.message, 'error');
            } finally {
                // Reset button
                captureButton.disabled = false;
                captureSpinner.style.display = 'none';
                document.getElementById('capture-button-text').textContent = 'Capture Funds';
            }
        });
        
        // Load pending transactions
        async function loadPendingTransactions() {
            try {
                const transactionList = document.getElementById('transaction-list');
                const allTransactionsList = document.getElementById('all-transactions-list');
                
                // Show loading state
                transactionList.innerHTML = '<div class="empty-state">Loading transactions...</div>';
                allTransactionsList.innerHTML = '<div class="empty-state">Loading transactions...</div>';
                
                const response = await fetch(`${API_BASE_URL}/pending-transactions`);
                
                if (!response.ok) {
                    throw new Error('Failed to load transactions');
                }
                
                const transactions = await response.json();
                displayTransactions(transactions);
            } catch (error) {
                console.error('Error loading transactions:', error);
                const transactionList = document.getElementById('transaction-list');
                const allTransactionsList = document.getElementById('all-transactions-list');
                transactionList.innerHTML = '<div class="empty-state">Error loading transactions</div>';
                allTransactionsList.innerHTML = '<div class="empty-state">Error loading transactions</div>';
            }
        }
        
        // Display transactions in the UI
        function displayTransactions(transactions) {
            const transactionList = document.getElementById('transaction-list');
            const allTransactionsList = document.getElementById('all-transactions-list');
            
            if (!transactions || transactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-state">No recent pre-authorizations found</div>';
                allTransactionsList.innerHTML = '<div class="empty-state">No transactions found</div>';
                return;
            }
            
            // Filter for pending transactions (pre-authorizations)
            const pendingTransactions = transactions.filter(t => t.status === 'requires_capture');
            
            // Update pending transactions list
            if (pendingTransactions.length === 0) {
                transactionList.innerHTML = '<div class="empty-state">No recent pre-authorizations found</div>';
            } else {
                transactionList.innerHTML = pendingTransactions.map(transaction => `
                    <div class="transaction-item">
                        <div class="transaction-details">
                            <div class="transaction-amount">$${(transaction.amount / 100).toLocaleString()}</div>
                            <div class="transaction-id">${transaction.id}</div>
                            <div>Created: ${new Date(transaction.created * 1000).toLocaleDateString()}</div>
                        </div>
                        <div class="transaction-actions">
                            <button class="btn-small success" onclick="captureTransaction('${transaction.id}', ${transaction.amount})">
                                Capture
                            </button>
                        </div>
                    </div>
                `).join('');
            }
            
            // Update all transactions list
            allTransactionsList.innerHTML = transactions.map(transaction => `
                <div class="transaction-item">
                    <div class="transaction-details">
                        <div class="transaction-amount">$${(transaction.amount / 100).toLocaleString()}</div>
                        <div class="transaction-id">${transaction.id}</div>
                        <div>Status: ${formatStatus(transaction.status)}</div>
                        <div>Type: ${transaction.capture_method === 'manual' ? 'Pre-Authorization' : 'Payment'}</div>
                        <div>Created: ${new Date(transaction.created * 1000).toLocaleDateString()}</div>
                    </div>
                </div>
            `).join('');
        }
        
        // Format transaction status for display
        function formatStatus(status) {
            const statusMap = {
                'requires_payment_method': 'Payment Method Required',
                'requires_confirmation': 'Requires Confirmation',
                'requires_action': 'Requires Action',
                'processing': 'Processing',
                'requires_capture': 'Pending Capture',
                'canceled': 'Canceled',
                'succeeded': 'Completed'
            };
            
            return statusMap[status] || status;
        }
        
        // Capture transaction from the list
        async function captureTransaction(paymentIntentId, amount) {
            document.getElementById('payment-intent-id').value = paymentIntentId;
            document.getElementById('capture-amount').value = amount / 100;
            
            // Switch to capture tab
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelector('[data-tab="capture"]').classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById('capture-tab').classList.add('active');
        }
        
        // Refresh transactions button
        document.getElementById('refresh-transactions').addEventListener('click', function() {
            loadPendingTransactions();
            showMessage(captureMessage, 'Transactions refreshed', 'success');
        });
        
        // Utility functions
        function showMessage(element, message, type) {
            element.textContent = message;
            element.className = '';
            element.classList.add(type);
            element.style.display = 'block';
            
            // Auto-hide success messages after 5 seconds
            if (type === 'success') {
                setTimeout(() => {
                    element.style.display = 'none';
                }, 5000);
            }
        }
        
        // Rate limiting functions
        function isRateLimited() {
            const now = Date.now();
            
            // Reset attempts if window has passed
            if (now - lastAttemptTime > RATE_LIMIT.window) {
                rateLimitAttempts = 0;
            }
            
            // Check if we're in lockout period
            if (now < rateLimitResetTime) {
                return true;
            }
            
            // Check if we've exceeded attempt limit
            if (rateLimitAttempts >= RATE_LIMIT.attempts) {
                rateLimitResetTime = now + RATE_LIMIT.lockout;
                return true;
            }
            
            return false;
        }
        
        function recordFailedAttempt() {
            const now = Date.now();
            
            // Reset attempts if window has passed
            if (now - lastAttemptTime > RATE_LIMIT.window) {
                rateLimitAttempts = 0;
            }
            
            rateLimitAttempts++;
            lastAttemptTime = now;
        }
        
        function resetRateLimit() {
            rateLimitAttempts = 0;
            rateLimitResetTime = 0;
        }
        
        // Initialize form validation
        validateForm();
        
        // Make captureTransaction function available globally
        window.captureTransaction = captureTransaction;
    </script>
</body>
</html>
